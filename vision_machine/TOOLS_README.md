# üõ†Ô∏è Sistema de Ferramentas da Vision Machine - Guia Completo

> üìñ **Projeto Principal**: [analyticLens - README Geral](../../README.md)

## üìã **Vis√£o Geral**

O sistema de ferramentas da Vision Machine √© uma arquitetura modular que permite criar pipelines de inspe√ß√£o personalizados atrav√©s de configura√ß√£o JSON. Cada ferramenta processa imagens de forma independente e pode referenciar resultados de ferramentas anteriores.

## üèóÔ∏è **Arquitetura**

### **Hierarquia de Classes**
```
BaseTool (abstrata)
‚îú‚îÄ‚îÄ GrayscaleTool (filtro)
‚îú‚îÄ‚îÄ BlobTool (an√°lise)
‚îî‚îÄ‚îÄ MathTool (matem√°tica)
```

### **Fluxo de Processamento**
1. **InspectionProcessor** coordena a execu√ß√£o sequencial
2. **Cache de imagens** evita reprocessamento desnecess√°rio
3. **Refer√™ncias entre ferramentas** permitem opera√ß√µes matem√°ticas
4. **Medi√ß√£o de tempo** para cada ferramenta e inspe√ß√£o completa

## üîß **Tipos de Ferramentas**

### **1. Ferramentas de Filtro (`filter`)**
- **Prop√≥sito**: Transformam a imagem para uso posterior
- **Exemplo**: `GrayscaleTool` - converte para escala de cinza
- **Caracter√≠stica**: Modificam a imagem e armazenam no cache

### **2. Ferramentas de An√°lise (`analysis`)**
- **Prop√≥sito**: Extraem informa√ß√µes e m√©tricas da imagem
- **Exemplo**: `BlobTool` - detecta e analisa blobs
- **Caracter√≠stica**: N√£o modificam a imagem, apenas analisam

### **3. Ferramentas Matem√°ticas (`math`)**
- **Prop√≥sito**: Realizam c√°lculos sobre resultados de outras ferramentas
- **Exemplo**: `MathTool` - opera√ß√µes matem√°ticas e f√≥rmulas customizadas
- **Caracter√≠stica**: Operam sobre dados, n√£o sobre imagens

## üìù **Configura√ß√£o das Ferramentas**

### **Estrutura Base**
```json
{
  "tools": [
    {
      "id": 1,
      "name": "nome_da_ferramenta",
      "type": "tipo_da_ferramenta",
      "ROI": {"x": 0, "y": 0, "w": 100, "h": 100},
      "inspec_pass_fail": true,
      "reference_tool_id": null
    }
  ]
}
```

### **Campos Comuns**
- **`id`**: Identificador √∫nico da ferramenta (obrigat√≥rio)
- **`name`**: Nome descritivo da ferramenta
- **`type`**: Tipo da ferramenta (`grayscale`, `blob`, `math`)
- **`ROI`**: Regi√£o de interesse para processamento
- **`inspec_pass_fail`**: Se os testes internos afetam o resultado geral
- **`reference_tool_id`**: ID da ferramenta cujo resultado ser√° usado como refer√™ncia

## üéØ **Ferramentas Dispon√≠veis**

### **1. GrayscaleTool**
**Tipo**: `grayscale` (filtro)

**Par√¢metros**:
- `method`: M√©todo de convers√£o (`luminance`, `average`, `weighted`)
- `normalize`: Se deve normalizar a imagem (`true`/`false`)

**Exemplo**:
```json
{
  "id": 1,
  "name": "grayscale_filter",
  "type": "grayscale",
  "ROI": {"x": 0, "y": 0, "w": 640, "h": 480},
  "method": "luminance",
  "normalize": true,
  "inspec_pass_fail": false
}
```

**Resultado**:
```json
{
  "tool_id": 1,
  "tool_name": "grayscale_filter",
  "tool_type": "grayscale",
  "processing_time_ms": 1.23,
  "image_modified": true,
  "status": "success"
}
```

### **2. BlobTool**
**Tipo**: `blob` (an√°lise)

**Par√¢metros**:
- `th_min`/`th_max`: Limites do threshold (0-255)
- `area_min`/`area_max`: Limites de √°rea dos blobs
- `test_total_area_min`/`test_total_area_max`: Limites para teste de √°rea total
- `test_blob_count_min`/`test_blob_count_max`: Limites para teste de contagem
- `total_area_test`: Se deve executar teste de √°rea total
- `blob_count_test`: Se deve executar teste de contagem

**Exemplo**:
```json
{
  "id": 2,
  "name": "blob_1",
  "type": "blob",
  "ROI": {"x": 0, "y": 10, "w": 100, "h": 100},
  "th_max": 255,
  "th_min": 130,
  "area_min": 100,
  "area_max": 1000,
  "test_total_area_max": 100,
  "test_total_area_min": 50,
  "test_blob_count_max": 5,
  "test_blob_count_min": 4,
  "total_area_test": true,
  "blob_count_test": true,
  "inspec_pass_fail": true
}
```

**Resultado**:
```json
{
  "tool_id": 2,
  "tool_name": "blob_1",
  "tool_type": "blob",
  "processing_time_ms": 2.45,
  "blobs": [
    {
      "area": 2674.5,
      "centroid": [23, 26],
      "bounding_box": [0, 0, 76, 80]
    }
  ],
  "blob_count": 5,
  "total_area": 3892.5,
  "roi_area": 360960.0,
  "test_results": {
    "total_area_test": {
      "passed": false,
      "min": 50.0,
      "max": 100.0,
      "actual": 3892.5
    },
    "blob_count_test": {
      "passed": true,
      "min": 4,
      "max": 5,
      "actual": 5
    },
    "overall_pass": false
  },
  "pass_fail": false
}
```

### **3. MathTool**
**Tipo**: `math` (matem√°tica)

**Par√¢metros**:
- `operation`: Opera√ß√£o matem√°tica (`area_ratio`, `blob_density`, `custom_formula`)
- `reference_tool_id`: ID da ferramenta de refer√™ncia
- `custom_formula`: F√≥rmula customizada (quando `operation` √© `custom_formula`)

**Exemplo**:
```json
{
  "id": 3,
  "name": "area_ratio_calc",
  "type": "math",
  "ROI": {"x": 0, "y": 0, "w": 640, "h": 480},
  "operation": "area_ratio",
  "reference_tool_id": 2,
  "inspec_pass_fail": true
}
```

**Resultado**:
```json
{
  "tool_id": 3,
  "tool_name": "area_ratio_calc",
  "tool_type": "math",
  "processing_time_ms": 0.12,
  "operation": "area_ratio",
  "result": 0.0108,
  "pass_fail": true,
  "status": "success"
}
```

## üöÄ **Como Usar**

### **1. Configura√ß√£o no vm_config.json**
```json
{
  "inspection_config": {
    "tools": [
      {
        "id": 1,
        "name": "grayscale_filter",
        "type": "grayscale",
        "ROI": {"x": 0, "y": 0, "w": 640, "h": 480},
        "method": "luminance",
        "normalize": true,
        "inspec_pass_fail": false
      },
      {
        "id": 2,
        "name": "blob_1",
        "type": "blob",
        "ROI": {"x": 0, "y": 10, "w": 100, "h": 100},
        "th_max": 255,
        "th_min": 130,
        "area_min": 100,
        "area_max": 1000,
        "test_total_area_max": 100,
        "test_total_area_min": 50,
        "test_blob_count_max": 5,
        "test_blob_count_min": 4,
        "total_area_test": true,
        "blob_count_test": true,
        "inspec_pass_fail": true
      }
    ]
  }
}
```

### **2. Execu√ß√£o Autom√°tica**
```bash
cd vision_machine
python vm.py
```

### **3. Atualiza√ß√£o Din√¢mica via API**
```bash
# GET - Obter configura√ß√£o atual
curl http://localhost:5000/api/inspection_config

# PUT - Atualizar configura√ß√£o
curl -X PUT http://localhost:5000/api/inspection_config \
  -H "Content-Type: application/json" \
  -d @nova_config.json
```

## üìä **Estrutura dos Resultados**

### **Resultado da Inspe√ß√£o Completa**
```json
{
  "inspection_summary": {
    "total_processing_time_ms": 15.67,
    "tools_processing_time_ms": 12.34,
    "overhead_time_ms": 3.33,
    "overall_pass": false,
    "timestamp": "2025-08-17 02:09:03"
  },
  "tool_results": [
    // Resultados individuais de cada ferramenta
  ],
  "final_image": "base64_encoded_image_data"
}
```

### **Campos WebSocket**
- **`time`**: Tempo total de processamento da inspe√ß√£o
- **`tools`**: Configura√ß√£o JSON das ferramentas
- **`result`**: Lista de resultados de todas as ferramentas

## üîç **Debugging e Troubleshooting**

### **Logs de Processamento**
```
 Iniciando inspe√ß√£o com 2 ferramentas...
   1Ô∏è‚É£ Processando grayscale_filter (ID: 1)...
   üîÑ Usando imagem grayscale j√° processada para blob_1
   2Ô∏è‚É£ Processando blob_1 (ID: 2)...
   ‚úÖ Pipeline funcionando corretamente
   üìä Grayscale: 1.23ms
   üìä Blob: 2.45ms
   üéØ Sem duplica√ß√£o de processamento grayscale
```

### **Problemas Comuns**
1. **Erro de serializa√ß√£o JSON**: Arrays numpy n√£o s√£o serializ√°veis
2. **Incompatibilidade de canais**: Imagens 2-channel vs 3-channel
3. **ROI fora dos limites**: Verificar coordenadas do ROI
4. **Configura√ß√£o n√£o atualizada**: Recriar InspectionProcessor

### **Valida√ß√£o de Configura√ß√£o**
```python
# Cada ferramenta implementa validate_config()
if not tool.validate_config():
    print(f"‚ùå Configura√ß√£o inv√°lida para {tool.name}")
```

## üéØ **Otimiza√ß√µes Implementadas**

### **1. Cache de Imagens Processadas**
- Ferramentas de filtro armazenam imagens processadas
- Ferramentas subsequentes reutilizam imagens j√° processadas
- Evita reprocessamento desnecess√°rio

### **2. Pipeline Otimizado**
```
GrayscaleTool ‚Üí [Cache] ‚Üí BlobTool
     ‚Üì              ‚Üì         ‚Üì
  Processa    Armazena   Reutiliza
```

### **3. Medi√ß√£o de Tempo**
- Tempo individual de cada ferramenta
- Tempo total da inspe√ß√£o
- Overhead de processamento

## üîÆ **Pr√≥ximos Passos**

### **Ferramentas Planejadas**
- **Edge Detection**: Detec√ß√£o de bordas
- **Color Analysis**: An√°lise de cores
- **Pattern Matching**: Correspond√™ncia de padr√µes
- **OCR**: Reconhecimento de texto

### **Melhorias T√©cnicas**
- **Paraleliza√ß√£o**: Execu√ß√£o paralela de ferramentas independentes
- **GPU Acceleration**: Uso de CUDA para processamento
- **Machine Learning**: Integra√ß√£o com modelos ML
- **Plugin System**: Sistema de plugins para ferramentas customizadas

---

## üìû **Suporte**

Para d√∫vidas ou problemas com o sistema de ferramentas:
1. Verifique os logs de processamento
2. Valide a configura√ß√£o JSON
3. Teste com `test_tools.py`
4. Use `test_user_vm.py` para testes manuais

---

# üéÆ **Comandos da API para Gerenciamento de Tools**

## üì° **Endpoint Principal**

Todos os comandos de tools s√£o executados atrav√©s do endpoint:
```
POST /api/control
```

## üîß **Comando config_tool**

### **Descri√ß√£o**
Atualiza ou adiciona uma ferramenta de inspe√ß√£o na Vision Machine em tempo real.

### **Formato da Requisi√ß√£o**
```json
{
  "command": "config_tool",
  "params": {
    "id": 1,
    "name": "grayscale_filter",
    "type": "grayscale",
    "ROI": {
      "x": 0,
      "y": 0,
      "w": 752,
      "h": 480
    },
    "method": "luminance",
    "normalize": true,
    "inspec_pass_fail": false
  }
}
```

### **Comportamento**

#### **1. Atualiza√ß√£o de Tool Existente**
Se uma tool com o mesmo `id` e `name` j√° existir na configura√ß√£o, ela ser√° **atualizada** com os novos par√¢metros.

**Exemplo de atualiza√ß√£o:**
```json
{
  "command": "config_tool",
  "params": {
    "id": 1,
    "name": "grayscale_filter",
    "ROI": {
      "x": 50,    // Mudando posi√ß√£o X
      "y": 50,    // Mudando posi√ß√£o Y
      "w": 700,   // Mudando largura
      "h": 400    // Mudando altura
    }
  }
}
```

#### **2. Adi√ß√£o de Nova Tool**
Se n√£o existir uma tool com o mesmo `id` e `name`, uma nova tool ser√° **adicionada** ao final da fila de tools.

**Exemplo de nova tool:**
```json
{
  "command": "config_tool",
  "params": {
    "id": 999,           // Ser√° substitu√≠do por ID √∫nico
    "name": "math_tool", // Nome √∫nico
    "type": "math",
    "operation": "add",
    "value": 50
  }
}
```

**Nota:** Se o `id` fornecido j√° existir, um novo ID √∫nico ser√° gerado automaticamente.

### **Resposta da API**

#### **Sucesso (200)**
```json
{
  "success": true,
  "tool_id": 1,
  "tool_name": "grayscale_filter",
  "action": "updated",  // "updated" ou "added"
  "total_tools": 3
}
```

#### **Erro (400/500)**
```json
{
  "success": false,
  "error": "Mensagem de erro descritiva"
}
```

### **A√ß√µes Autom√°ticas**
Ap√≥s executar o comando `config_tool`, a VM automaticamente:

1. ‚úÖ **Valida** a configura√ß√£o da tool
2. ‚úÖ **Atualiza** ou **adiciona** a tool na configura√ß√£o
3. ‚úÖ **Recria** o processador de inspe√ß√£o com a nova configura√ß√£o
4. ‚úÖ **Salva** a configura√ß√£o no arquivo JSON
5. ‚úÖ **Aplica** a nova configura√ß√£o para inspe√ß√µes atuais

## üóëÔ∏è **Comando delete_tool**

### **Descri√ß√£o**
Remove uma ferramenta de inspe√ß√£o pelo ID.

### **Formato da Requisi√ß√£o**
```json
{
  "command": "delete_tool",
  "params": {
    "id": 2
  }
}
```

### **Par√¢metros**
- **id**: ID da tool a ser removida (inteiro obrigat√≥rio)

### **Comportamento**
- **Tool Encontrada**: Remove a tool e recria o processador
- **Tool Inexistente**: Retorna erro 500 com mensagem descritiva
- **Par√¢metros Inv√°lidos**: Retorna erro 400 com valida√ß√£o
- **Configura√ß√£o**: Salva automaticamente ap√≥s remo√ß√£o

### **Resposta da API**

#### **Sucesso (200)**
```json
{
  "success": true,
  "tool_id": 2,
  "tool_name": "blob_1",
  "action": "deleted",
  "total_tools": 1
}
```

#### **Erro (400/500)**
```json
{
  "success": false,
  "error": "Mensagem de erro descritiva"
}
```

### **A√ß√µes Autom√°ticas**
Ap√≥s executar o comando `delete_tool`, a VM automaticamente:

1. ‚úÖ **Valida** se a tool existe
2. ‚úÖ **Remove** a tool da configura√ß√£o
3. ‚úÖ **Recria** o processador de inspe√ß√£o (se houver tools restantes)
4. ‚úÖ **Salva** a configura√ß√£o no arquivo JSON
5. ‚úÖ **Retorna** informa√ß√µes da opera√ß√£o

## üìã **Exemplos de Uso**

### **Python**

```python
import requests

# Atualizar tool existente
response = requests.post("http://localhost:5000/api/control", json={
    "command": "config_tool",
    "params": {
        "id": 1,
        "name": "grayscale_filter",
        "ROI": {"x": 100, "y": 100, "w": 600, "h": 300}
    }
})

# Remover tool
response = requests.post("http://localhost:5000/api/control", json={
    "command": "delete_tool",
    "params": {"id": 2}
})

if response.status_code == 200:
    result = response.json()
    print(f"Tool {result['tool_name']} {result['action']} com sucesso!")
```

### **cURL**

```bash
# Atualizar tool existente
curl -X POST http://localhost:5000/api/control \
  -H "Content-Type: application/json" \
  -d '{
    "command": "config_tool",
    "params": {
      "id": 1,
      "name": "grayscale_filter",
      "ROI": {"x": 100, "y": 100, "w": 600, "h": 300}
    }
  }'

# Remover tool
curl -X POST http://localhost:5000/api/control \
  -H "Content-Type: application/json" \
  -d '{
    "command": "delete_tool",
    "params": {"id": 2}
  }'
```

## ‚ö†Ô∏è **Valida√ß√µes e Tratamento de Erros**

### **Valida√ß√µes Implementadas**

#### **config_tool**
- ‚úÖ Presen√ßa dos campos obrigat√≥rios (`id` e `name`)
- ‚úÖ Estrutura da configura√ß√£o da tool
- ‚úÖ Compatibilidade com o sistema de ferramentas
- ‚úÖ Integridade da configura√ß√£o geral

#### **delete_tool**
- ‚úÖ ID da tool deve ser fornecido
- ‚úÖ ID deve ser um n√∫mero inteiro v√°lido
- ‚úÖ Tool deve existir na configura√ß√£o
- ‚úÖ Lista de tools n√£o pode estar vazia

### **Tratamento de Erros**

#### **Erro 400: Par√¢metros Inv√°lidos**
- Campos obrigat√≥rios ausentes
- Formato de dados incorreto
- Tipos de dados inv√°lidos

#### **Erro 500: Erro Interno**
- Falha ao recriar processador de ferramentas
- Erro ao salvar configura√ß√£o
- Problemas com sistema de ferramentas
- Tool n√£o encontrada para remo√ß√£o

## üìù **Logs e Debugging**

### **Logs Gerados**

#### **config_tool**
```
üîß Comando config_tool recebido
üîÑ Atualizando tool existente: grayscale_filter (ID: 1)
‚úÖ Tool grayscale_filter atualizada com sucesso
‚úÖ Processador de ferramentas recriado com 2 ferramentas
‚úÖ Configura√ß√£o de tool grayscale_filter atualizada e salva
```

#### **delete_tool**
```
üóëÔ∏è Comando delete_tool recebido
üóëÔ∏è Tool removida: blob_1 (ID: 2)
‚úÖ Processador de ferramentas recriado com 1 ferramenta
‚úÖ Tool blob_1 removida e configura√ß√£o salva
```

### **Informa√ß√µes de Debug**
- **Status da VM**: Verifica√ß√£o de conectividade
- **Configura√ß√µes**: Detalhes das tools testadas
- **Respostas da API**: Status codes e mensagens
- **Tempos de Processamento**: Performance das ferramentas

---

# üîç **Explica√ß√£o Profunda dos Par√¢metros das Tools**

## üìê **Par√¢metros Comuns a Todas as Tools**

### **`id` (Obrigat√≥rio)**
- **Tipo**: Integer
- **Descri√ß√£o**: Identificador √∫nico da ferramenta
- **Valores**: Qualquer n√∫mero inteiro positivo
- **Exemplo**: `1`, `2`, `100`
- **Nota**: Deve ser √∫nico dentro da configura√ß√£o

### **`name` (Obrigat√≥rio)**
- **Tipo**: String
- **Descri√ß√£o**: Nome descritivo da ferramenta
- **Valores**: Qualquer string v√°lida
- **Exemplo**: `"grayscale_filter"`, `"blob_detector"`, `"area_calculator"`
- **Nota**: Deve ser √∫nico dentro da configura√ß√£o

### **`type` (Obrigat√≥rio)**
- **Tipo**: String
- **Descri√ß√£o**: Tipo da ferramenta
- **Valores**: `"grayscale"`, `"blob"`, `"math"`
- **Exemplo**: `"grayscale"`
- **Nota**: Determina a classe da ferramenta a ser instanciada

### **`ROI` (Obrigat√≥rio)**
- **Tipo**: Object
- **Descri√ß√£o**: Regi√£o de interesse para processamento
- **Estrutura**: `{"x": 0, "y": 0, "w": 100, "h": 100}`

#### **Subpar√¢metros do ROI:**
- **`x`**: Posi√ß√£o X do canto superior esquerdo (pixels)
- **`y`**: Posi√ß√£o Y do canto superior esquerdo (pixels)
- **`w`**: Largura da regi√£o (pixels)
- **`h`**: Altura da regi√£o (pixels)

**Exemplo**: `{"x": 50, "y": 100, "w": 200, "h": 150}`

### **`inspec_pass_fail` (Opcional)**
- **Tipo**: Boolean
- **Descri√ß√£o**: Se os testes internos afetam o resultado geral da inspe√ß√£o
- **Valores**: `true` ou `false`
- **Padr√£o**: `false`
- **Exemplo**: `true`
- **Nota**: Tools com `true` podem fazer a inspe√ß√£o falhar

### **`reference_tool_id` (Opcional)**
- **Tipo**: Integer ou null
- **Descri√ß√£o**: ID da ferramenta cujo resultado ser√° usado como refer√™ncia
- **Valores**: ID de ferramenta existente ou `null`
- **Padr√£o**: `null`
- **Exemplo**: `2`
- **Nota**: Usado principalmente por ferramentas matem√°ticas

## üé® **Par√¢metros Espec√≠ficos da GrayscaleTool**

### **`method` (Obrigat√≥rio)**
- **Tipo**: String
- **Descri√ß√£o**: M√©todo de convers√£o para escala de cinza
- **Valores**: `"luminance"`, `"average"`, `"weighted"`
- **Padr√£o**: `"luminance"`

#### **M√©todos Dispon√≠veis:**

##### **`"luminance"`**
- **F√≥rmula**: `0.299 * R + 0.587 * G + 0.114 * B`
- **Caracter√≠sticas**: 
  - Mais pr√≥ximo da percep√ß√£o humana
  - Verde tem peso maior (58.7%)
  - Azul tem peso menor (11.4%)
- **Uso**: Padr√£o para inspe√ß√£o visual
- **Exemplo**: `"method": "luminance"`

##### **`"average"`**
- **F√≥rmula**: `(R + G + B) / 3`
- **Caracter√≠sticas**:
  - Simples e r√°pido
  - Todos os canais t√™m peso igual
  - Pode n√£o representar bem a luminosidade
- **Uso**: Processamento r√°pido quando precis√£o n√£o √© cr√≠tica
- **Exemplo**: `"method": "average"`

##### **`"weighted"`**
- **F√≥rmula**: `0.2126 * R + 0.7152 * G + 0.0722 * B`
- **Caracter√≠sticas**:
  - Baseado no padr√£o sRGB
  - Verde tem peso ainda maior (71.52%)
  - Azul tem peso ainda menor (7.22%)
- **Uso**: Processamento de imagens sRGB
- **Exemplo**: `"method": "weighted"`

### **`normalize` (Opcional)**
- **Tipo**: Boolean
- **Descri√ß√£o**: Se deve normalizar a imagem ap√≥s convers√£o
- **Valores**: `true` ou `false`
- **Padr√£o**: `false`

#### **Comportamento:**
- **`true`**: Aplica normaliza√ß√£o para melhorar contraste
- **`false`**: Mant√©m valores originais
- **Exemplo**: `"normalize": true`

## üîç **Par√¢metros Espec√≠ficos da BlobTool**

### **`th_min` e `th_max` (Obrigat√≥rios)**
- **Tipo**: Integer
- **Descri√ß√£o**: Limites do threshold para detec√ß√£o de blobs
- **Valores**: 0 a 255
- **Padr√£o**: `th_min: 0`, `th_max: 255`

#### **Comportamento:**
- **`th_min`**: Valor m√≠nimo para considerar pixel como blob
- **`th_max`**: Valor m√°ximo para considerar pixel como blob
- **Exemplo**: `"th_min": 130, "th_max": 255`
- **Nota**: Pixels com valor entre `th_min` e `th_max` s√£o considerados blobs

### **`area_min` e `area_max` (Obrigat√≥rios)**
- **Tipo**: Float
- **Descri√ß√£o**: Limites de √°rea dos blobs individuais
- **Valores**: Qualquer n√∫mero positivo
- **Padr√£o**: `area_min: 0`, `area_max: inf`

#### **Comportamento:**
- **`area_min`**: √Årea m√≠nima para considerar blob v√°lido
- **`area_max`**: √Årea m√°xima para considerar blob v√°lido
- **Exemplo**: `"area_min": 100, "area_max": 1000`
- **Nota**: Blobs fora desses limites s√£o ignorados

### **`test_total_area_min` e `test_total_area_max` (Opcionais)**
- **Tipo**: Float
- **Descri√ß√£o**: Limites para teste de √°rea total de todos os blobs
- **Valores**: Qualquer n√∫mero positivo
- **Padr√£o**: `null` (teste desabilitado)

#### **Comportamento:**
- **`test_total_area_min`**: √Årea total m√≠nima aceit√°vel
- **`test_total_area_max`**: √Årea total m√°xima aceit√°vel
- **Exemplo**: `"test_total_area_min": 50, "test_total_area_max": 100`
- **Nota**: S√≥ funciona se `total_area_test: true`

### **`test_blob_count_min` e `test_blob_count_max` (Opcionais)**
- **Tipo**: Integer
- **Descri√ß√£o**: Limites para teste de contagem de blobs
- **Valores**: Qualquer n√∫mero inteiro positivo
- **Padr√£o**: `null` (teste desabilitado)

#### **Comportamento:**
- **`test_blob_count_min`**: N√∫mero m√≠nimo de blobs aceit√°vel
- **`test_blob_count_max`**: N√∫mero m√°ximo de blobs aceit√°vel
- **Exemplo**: `"test_blob_count_min": 4, "test_blob_count_max": 5`
- **Nota**: S√≥ funciona se `blob_count_test: true`

### **`total_area_test` (Opcional)**
- **Tipo**: Boolean
- **Descri√ß√£o**: Se deve executar teste de √°rea total
- **Valores**: `true` ou `false`
- **Padr√£o**: `false`

#### **Comportamento:**
- **`true`**: Executa teste de √°rea total
- **`false`**: Ignora teste de √°rea total
- **Exemplo**: `"total_area_test": true`
- **Nota**: Requer `test_total_area_min` e `test_total_area_max`

### **`blob_count_test` (Opcional)**
- **Tipo**: Boolean
- **Descri√ß√£o**: Se deve executar teste de contagem de blobs
- **Valores**: `true` ou `false`
- **Padr√£o**: `false`

#### **Comportamento:**
- **`true`**: Executa teste de contagem
- **`false`**: Ignora teste de contagem
- **Exemplo**: `"blob_count_test": true`
- **Nota**: Requer `test_blob_count_min` e `test_blob_count_max`

## üßÆ **Par√¢metros Espec√≠ficos da MathTool**

### **`operation` (Obrigat√≥rio)**
- **Tipo**: String
- **Descri√ß√£o**: Tipo de opera√ß√£o matem√°tica a ser executada
- **Valores**: `"area_ratio"`, `"blob_density"`, `"custom_formula"`
- **Padr√£o**: Nenhum (obrigat√≥rio)

#### **Opera√ß√µes Dispon√≠veis:**

##### **`"area_ratio"`**
- **Descri√ß√£o**: Calcula a raz√£o entre √°rea de blobs e √°rea total do ROI
- **F√≥rmula**: `total_blob_area / roi_area`
- **Requisitos**: `reference_tool_id` deve apontar para uma BlobTool
- **Resultado**: Valor entre 0 e 1
- **Exemplo**: `"operation": "area_ratio"`

##### **`"blob_density"`**
- **Descri√ß√£o**: Calcula a densidade de blobs por √°rea
- **F√≥rmula**: `blob_count / roi_area`
- **Requisitos**: `reference_tool_id` deve apontar para uma BlobTool
- **Resultado**: Blobs por pixel¬≤
- **Exemplo**: `"operation": "blob_density"`

##### **`"custom_formula"`**
- **Descri√ß√£o**: Executa f√≥rmula customizada
- **F√≥rmula**: Definida em `custom_formula`
- **Requisitos**: `custom_formula` deve ser definida
- **Resultado**: Resultado da f√≥rmula customizada
- **Exemplo**: `"operation": "custom_formula"`

### **`custom_formula` (Opcional)**
- **Tipo**: String
- **Descri√ß√£o**: F√≥rmula customizada para opera√ß√£o matem√°tica
- **Valores**: Express√£o matem√°tica v√°lida
- **Padr√£o**: `null`
- **Exemplo**: `"custom_formula": "blob_count * 2 + total_area / 100"`

#### **Vari√°veis Dispon√≠veis:**
- **`blob_count`**: N√∫mero de blobs da ferramenta de refer√™ncia
- **`total_area`**: √Årea total dos blobs da ferramenta de refer√™ncia
- **`roi_area`**: √Årea da regi√£o de interesse
- **`blob_areas`**: Lista de √°reas individuais dos blobs

#### **Operadores Suportados:**
- **Aritm√©ticos**: `+`, `-`, `*`, `/`, `%`
- **Compara√ß√£o**: `==`, `!=`, `>`, `<`, `>=`, `<=`
- **L√≥gicos**: `and`, `or`, `not`
- **Par√™nteses**: `()`

## üìä **Exemplos de Configura√ß√£o Completa**

### **Pipeline B√°sico: Grayscale + Blob**
```json
{
  "tools": [
    {
      "id": 1,
      "name": "grayscale_converter",
      "type": "grayscale",
      "ROI": {"x": 0, "y": 0, "w": 640, "h": 480},
      "method": "luminance",
      "normalize": true,
      "inspec_pass_fail": false
    },
    {
      "id": 2,
      "name": "defect_detector",
      "type": "blob",
      "ROI": {"x": 100, "y": 100, "w": 200, "h": 200},
      "th_min": 150,
      "th_max": 255,
      "area_min": 50,
      "area_max": 500,
      "test_total_area_min": 0,
      "test_total_area_max": 1000,
      "test_blob_count_min": 0,
      "test_blob_count_max": 5,
      "total_area_test": true,
      "blob_count_test": true,
      "inspec_pass_fail": true
    }
  ]
}
```

### **Pipeline Avan√ßado: Grayscale + Blob + Math**
```json
{
  "tools": [
    {
      "id": 1,
      "name": "grayscale_converter",
      "type": "grayscale",
      "ROI": {"x": 0, "y": 0, "w": 640, "h": 480},
      "method": "weighted",
      "normalize": false,
      "inspec_pass_fail": false
    },
    {
      "id": 2,
      "name": "defect_detector",
      "type": "blob",
      "ROI": {"x": 50, "y": 50, "w": 300, "h": 300},
      "th_min": 120,
      "th_max": 255,
      "area_min": 25,
      "area_max": 1000,
      "test_total_area_min": 0,
      "test_total_area_max": 5000,
      "test_blob_count_min": 0,
      "test_blob_count_max": 10,
      "total_area_test": true,
      "blob_count_test": true,
      "inspec_pass_fail": true
    },
    {
      "id": 3,
      "name": "quality_calculator",
      "type": "math",
      "ROI": {"x": 0, "y": 0, "w": 640, "h": 480},
      "operation": "area_ratio",
      "reference_tool_id": 2,
      "inspec_pass_fail": true
    }
  ]
}
```

### **Pipeline com F√≥rmula Customizada**
```json
{
  "tools": [
    {
      "id": 1,
      "name": "grayscale_converter",
      "type": "grayscale",
      "ROI": {"x": 0, "y": 0, "w": 640, "h": 480},
      "method": "luminance",
      "normalize": true,
      "inspec_pass_fail": false
    },
    {
      "id": 2,
      "name": "defect_detector",
      "type": "blob",
      "ROI": {"x": 0, "y": 0, "w": 640, "h": 480},
      "th_min": 100,
      "th_max": 255,
      "area_min": 10,
      "area_max": 1000,
      "test_total_area_min": 0,
      "test_total_area_max": 10000,
      "test_blob_count_min": 0,
      "test_blob_count_max": 20,
      "total_area_test": true,
      "blob_count_test": true,
      "inspec_pass_fail": true
    },
    {
      "id": 3,
      "name": "custom_quality_score",
      "type": "math",
      "ROI": {"x": 0, "y": 0, "w": 640, "h": 480},
      "operation": "custom_formula",
      "reference_tool_id": 2,
      "custom_formula": "100 - (total_area / roi_area * 100) - (blob_count * 2)",
      "inspec_pass_fail": true
    }
  ]
}
```

## üéØ **Dicas de Configura√ß√£o**

### **1. Ordem das Ferramentas**
- **Ferramentas de filtro** devem vir primeiro
- **Ferramentas de an√°lise** devem vir depois dos filtros
- **Ferramentas matem√°ticas** devem vir por √∫ltimo

### **2. Configura√ß√£o de ROI**
- **ROI pequeno**: Processamento mais r√°pido, menos ru√≠do
- **ROI grande**: Mais contexto, mas pode incluir ru√≠do
- **ROI sobreposto**: Pode ser √∫til para an√°lise em diferentes escalas

### **3. Thresholds para Blob Detection**
- **`th_min` baixo**: Detecta mais objetos (pode incluir ru√≠do)
- **`th_max` alto**: Detecta objetos mais claros
- **Teste com valores**: Use ferramentas de visualiza√ß√£o para ajustar

### **4. Testes de Pass/Fail**
- **`inspec_pass_fail: false`**: Para ferramentas de pr√©-processamento
- **`inspec_pass_fail: true`**: Para ferramentas de decis√£o final
- **Testes m√∫ltiplos**: Combine √°rea total e contagem para robustez

---

# üß™ **Sistema de Testes**

## üìã **Execu√ß√£o dos Testes**

### **Teste Completo**
```bash
# Na pasta vision_machine
python test_tools.py
```

### **Verifica√ß√£o Pr√©-Teste**
```bash
# Verificar se VM est√° rodando
curl http://localhost:5000/api/error

# Verificar configura√ß√£o atual
curl http://localhost:5000/api/inspection_config
```

## üîÑ **Sistema de Backup/Restaura√ß√£o**

O sistema de testes implementa:
- ‚úÖ **Backup autom√°tico** da configura√ß√£o atual
- ‚úÖ **Execu√ß√£o segura** dos testes
- ‚úÖ **Restaura√ß√£o garantida** da configura√ß√£o original
- ‚úÖ **Isolamento total** dos testes

## üìä **Resultados Esperados**

```
üìà Resumo: 4/4 testes passaram
üéâ Todos os testes passaram com sucesso!
```

---

# üèÅ **Conclus√£o**

Este guia completo cobre todos os aspectos do sistema de ferramentas da Vision Machine, incluindo:

1. **Configura√ß√£o detalhada** de cada tipo de ferramenta
2. **Comandos da API** para gerenciamento din√¢mico
3. **Explica√ß√£o profunda** de todos os par√¢metros
4. **Exemplos pr√°ticos** de configura√ß√£o
5. **Sistema de testes** com backup/restaura√ß√£o
6. **Dicas e melhores pr√°ticas** para configura√ß√£o

Com essas informa√ß√µes, voc√™ pode configurar, gerenciar e otimizar completamente o sistema de ferramentas para suas necessidades espec√≠ficas de inspe√ß√£o.
