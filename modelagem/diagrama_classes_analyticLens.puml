@startuml AnalyticLens_Class_Diagram

!theme plain
skinparam classAttributeIconSize 0
skinparam classFontSize 12
skinparam classFontName Arial
skinparam packageStyle rectangle

' ========================================
' PACKAGES
' ========================================
package "Frontend (Vue.js)" {
  package "Components" {
    class App {
      + mounted()
      + setup()
    }
    
    class DashboardView {
      + machines: Array
      + inspections: Array
      + systemStatus: Object
      + refreshData()
    }
    
    class MachineManagementView {
      + machines: Array
      + selectedMachine: Object
      + addMachine()
      + editMachine()
      + removeMachine()
      + viewMachineStatus()
    }
    
    class InspectionEditView {
      + inspectionData: Object
      + selectedMachine: Object
      + onPipelineUpdated()
      + saveInspection()
      + sendToMachine()
    }
    
    class ToolsCanvas {
      + elements: Array
      + selectedTool: Object
      + selectedNode: Object
      + addToolNode()
      + selectNode()
      + updateNodeParameters()
      + savePipeline()
    }
    
    class ToolProperties {
      + tool: Object
      + parameters: Object
      + update()
    }
    
    class ToolNode {
      + data: Object
      + position: Object
      + selectNode()
    }
  }
  
  package "Stores (Pinia)" {
    class AuthStore {
      + user: Object
      + isAuthenticated: Boolean
      + login()
      + logout()
      + fetchUser()
    }
    
    class MachinesStore {
      + machines: Array
      + selectedMachine: Object
      + fetchMachines()
      + addMachine()
      + updateMachine()
      + removeMachine()
      + getMachineStatus()
    }
    
    class ToolsStore {
      + availableTools: Array
      + selectedTool: Object
      + fetchTools()
      + selectTool()
      + clearSelection()
    }
    
    class InspectionsStore {
      + inspections: Array
      + createInspection()
      + fetchInspections()
      + updateInspection()
      + deleteInspection()
      + sendToMachine()
      + getResults()
    }
  }
  
  package "Utils" {
    class Validation {
      + VALIDATION_TYPES: Object
      + validators: Object
      + validateField()
      + validateObject()
      + createValidationRules()
    }
    
    class HttpClient {
      + baseURL: String
      + get()
      + post()
      + put()
      + delete()
    }
  }
}

package "Backend (Django - Orquestrador)" {
  package "Models" {
    class User {
      + username: String
      + email: String
      + first_name: String
      + last_name: String
      + is_active: Boolean
      + date_joined: DateTime
    }
    
    class InspectionMachine {
      + id: UUID
      + name: String
      + location: String
      + ip_address: GenericIPAddressField
      + port: Integer
      + status: String
      + last_heartbeat: DateTime
      + max_concurrent_inspections: Integer
      + current_inspections: Integer
      + supported_inspection_types: JSONField
      + hardware_specs: JSONField
      + public_token: String
      + ip_whitelist: Array
      + is_available: Boolean
      + api_url: String
    }
    
    class MachineHeartbeat {
      + machine: ForeignKey(InspectionMachine)
      + timestamp: DateTime
      + status: String
      + system_info: JSONField
      + performance_metrics: JSONField
    }
    
    class DistributedInspection {
      + id: UUID
      + machine: ForeignKey(InspectionMachine)
      + image: ImageField
      + inspection_type: String
      + status: String
      + pipeline_config: JSONField
      + created_at: DateTime
      + assigned_at: DateTime
      + started_at: DateTime
      + completed_at: DateTime
      + results: JSONField
      + error_message: Text
      + processing_time: Float
      + assign_to_machine()
      + mark_as_processing()
      + mark_as_completed()
      + mark_as_failed()
    }
    
    class InspectionQueue {
      + inspection: OneToOneField(DistributedInspection)
      + priority: Integer
      + queued_at: DateTime
    }
    
    class ToolBase {
      <<abstract>>
      + name: String
      + description: Text
      + version: String
      + is_active: Boolean
      + parameters_schema: JSONField
      + created_at: DateTime
      + updated_at: DateTime
      + get_parameters()
    }
    
    class BlobDetectionTool {
      + min_area: Integer
      + max_area: Integer
      + threshold_value: Integer
      + get_parameters()
    }
    
    class InspectionResult {
      + inspection: ForeignKey(DistributedInspection)
      + image_path: String
      + execution_time: Float
      + success: Boolean
      + error_message: Text
      + results_data: JSONField
      + created_at: DateTime
    }
  }
  
  package "Views (DRF)" {
    class MachineViewSet {
      + list()
      + retrieve()
      + create()
      + update()
      + destroy()
      + get_status()
      + get_heartbeat()
    }
    
    class InspectionViewSet {
      + list()
      + retrieve()
      + create()
      + update()
      + destroy()
      + send_to_machine()
      + get_results()
    }
    
    class MachineOrchestratorView {
      + discover_machines()
      + distribute_inspection()
      + collect_results()
      + manage_queue()
    }
    
    class WebhookReceiverView {
      + receive_results()
      + receive_heartbeat()
      + receive_status_update()
    }
  }
  
  package "Serializers" {
    class UserSerializer {
      + fields: Array
      + validate()
    }
    
    class InspectionMachineSerializer {
      + fields: Array
      + validate()
    }
    
    class DistributedInspectionSerializer {
      + fields: Array
      + validate()
    }
    
    class InspectionResultSerializer {
      + fields: Array
      + validate()
    }
  }
  
  package "Orchestration Engine" {
    class MachineManager {
      + machines: Dict
      + register_machine()
      + get_machine()
      + list_machines()
      + update_machine_status()
    }
    
    class TaskDistributor {
      + distribute_inspection()
      + select_best_machine()
      + manage_queue()
      + handle_failures()
    }
    
    class SecurityManager {
      + validate_token()
      + validate_ip()
      + generate_session_token()
      + manage_authentication()
    }
  }
}

package "Máquinas de Visão (Flask)" {
  package "API Endpoints" {
    class FlaskApp {
      + app: Flask
      + run()
      + register_blueprints()
    }
    
    class MachineAPI {
      + /heartbeat
      + /status
      + /receive_inspection
      + /send_results
      + /update_config
    }
    
    class WebhookHandler {
      + handle_heartbeat()
      + handle_status_update()
      + handle_inspection_received()
      + handle_results_sent()
    }
  }
  
  package "Security" {
    class AuthenticationMiddleware {
      + validate_request()
      + check_ip_whitelist()
      + verify_public_token()
      + generate_session_token()
    }
    
    class SecurityConfig {
      + ip_whitelist: Array
      + public_token: String
      + session_token: String
      + token_expiration: DateTime
    }
  }
  
  package "Inspection Engine" {
    class InspectionExecutor {
      + execute_inspection()
      + load_pipeline_config()
      + run_tools()
      + collect_results()
    }
    
    class ToolRegistry {
      + tools: Dict
      + register_tool()
      + get_tool()
      + list_tools()
    }
    
    class ImageProcessor {
      + load_image()
      + preprocess()
      + postprocess()
      + save_result()
    }
  }
  
  package "Communication" {
    class DjangoCommunicator {
      + django_url: String
      + session_token: String
      + send_heartbeat()
      + send_results()
      + send_status()
    }
    
    class HeartbeatService {
      + interval: Integer
      + start()
      + stop()
      + send_heartbeat()
    }
  }
}

' ========================================
' RELACIONAMENTOS
' ========================================

' Frontend Relationships
App ||--o{ DashboardView : contains
App ||--o{ MachineManagementView : contains
App ||--o{ InspectionEditView : contains
InspectionEditView ||--o{ ToolsCanvas : contains
ToolsCanvas ||--o{ ToolNode : contains
ToolsCanvas ||--o{ ToolProperties : contains

' Store Relationships
AuthStore ||--o{ App : provides
MachinesStore ||--o{ MachineManagementView : provides
MachinesStore ||--o{ DashboardView : provides
ToolsStore ||--o{ ToolsCanvas : provides
InspectionsStore ||--o{ InspectionEditView : provides

' Backend Relationships
User ||--o{ DistributedInspection : creates
InspectionMachine ||--o{ DistributedInspection : processes
InspectionMachine ||--o{ MachineHeartbeat : generates
DistributedInspection ||--o{ InspectionResult : generates
DistributedInspection ||--o{ InspectionQueue : queued
ToolBase ||--o{ BlobDetectionTool : extends

' View Relationships
MachineViewSet ||--o{ InspectionMachineSerializer : uses
InspectionViewSet ||--o{ DistributedInspectionSerializer : uses
MachineOrchestratorView ||--o{ MachineManager : uses
MachineOrchestratorView ||--o{ TaskDistributor : uses
WebhookReceiverView ||--o{ SecurityManager : uses

' Orchestration Relationships
MachineManager ||--o{ InspectionMachine : manages
TaskDistributor ||--o{ DistributedInspection : distributes
SecurityManager ||--o{ InspectionMachine : authenticates

' Flask Machine Relationships
FlaskApp ||--o{ MachineAPI : provides
MachineAPI ||--o{ WebhookHandler : uses
FlaskApp ||--o{ AuthenticationMiddleware : uses
AuthenticationMiddleware ||--o{ SecurityConfig : validates
InspectionExecutor ||--o{ ToolRegistry : uses
InspectionExecutor ||--o{ ImageProcessor : uses
FlaskApp ||--o{ HeartbeatService : runs
HeartbeatService ||--o{ DjangoCommunicator : uses

' Cross-system Relationships
MachineViewSet ||--o{ MachineAPI : communicates
InspectionViewSet ||--o{ MachineAPI : communicates
WebhookReceiverView ||--o{ WebhookHandler : receives
TaskDistributor ||--o{ InspectionExecutor : distributes

' ========================================
' NOTES
' ========================================
note top of InspectionMachine : "Representa uma máquina de visão na rede com autenticação e monitoramento"
note top of MachineManager : "Gerencia o ciclo de vida das máquinas de inspeção"
note top of TaskDistributor : "Distribui inspeções para máquinas disponíveis baseado em capacidade e carga"
note top of SecurityManager : "Gerencia autenticação mútua entre Django e máquinas Flask"
note top of AuthenticationMiddleware : "Valida IP whitelist e tokens de autenticação"
note top of HeartbeatService : "Serviço que mantém comunicação periódica com o orquestrador Django"

@enduml
